<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>m-nome metronome</title>
    <script>
        let noteNames = {
            C: 'C',
            D: 'D',
            E: 'E',
            F: 'F',
            G: 'G',
            A: 'A',
            B: 'B'
        }

        let octaveNames = {
            neg01: '-1',
            pos04: '04'
        };

        let noteFrequencies = {};
        noteFrequencies[octaveNames.pos04] = {};
        noteFrequencies[octaveNames.pos04][noteNames.C] = 261.6;
        noteFrequencies[octaveNames.pos04][noteNames.D] = 293.7;

        function getBeatTime(bpm) {
            let minute = 60;
            return minute / bpm;
        }

        function getNoteFrequency(note) {
            return noteFrequencies[note.octave][note.name];
        }

        function getOscillator(audioContext, note) {
            let osc = audioContext.createOscillator();
            osc.frequency.value = getNoteFrequency(note);
            osc.connect(audioContext.destination);
            return osc;
        }

        //todo: add loop feature
        function scheduleNoteSequence(audioContext, startTime, bpm, noteSequence) {
            let currentTime = startTime;
            let beatTime = getBeatTime(bpm);
            noteSequence.forEach(currentNote => {
                let currentOscillator = getOscillator(audioContext, currentNote);
                currentOscillator.start(currentTime);
                currentOscillator.stop(currentTime + (beatTime * 0.9)); //todo: figure out how to incorporate note lengths
                currentTime += beatTime;
            });
        }

        function init() {
            let bpm = 90;
            let audioContext = new AudioContext();
            let startTime = audioContext.currentTime + 1;

            // audio time is not discrete
            // a sequence is a simplified representation
            let noteSequence = [
                // in this version a single note can be played at a time
                // note duration is set to the beat duration
                {name: noteNames.D, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.D, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.D, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.D, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
                {name: noteNames.C, octave: octaveNames.pos04},
            ];

            scheduleNoteSequence(audioContext, startTime, bpm, noteSequence);
        }

        init();
    </script>
</head>
<body>

</body>
</html>
